<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Rateio Pept√≠deos üíä</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0f0f1a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
  input:focus { outline: none; }
  button:active { opacity: 0.8; }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: #3730a3; border-radius: 99px; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;
const MAX_PER_ROUND = 10;
const ADMIN_PASS = "157842";
const PEPTIDES = [
  { id: "klow80", name: "KLOW 80MG", price: 116.60 },
  { id: "selank10", name: "SELANK 10MG", price: 34.48 },
  { id: "ghkcu50", name: "GHK-CU 50MG", price: 15.90 },
  { id: "ghkcu100", name: "GHK-Cu 100MG", price: 26.50 },
  { id: "thymosin10", name: "THYMOSIN ALPHA-1 10MG", price: 76.80 },
  { id: "retatrutide60", name: "RETATRUTIDE 60MG", price: 195.00 },
  { id: "retatrutide30", name: "RETATRUTIDE 30MG", price: 116.00 },
  { id: "tirzepatide60", name: "TIRZEPATIDE 60MG", price: 94.50 },
  { id: "tirzepatide30", name: "TIRZEPATIDE 30MG", price: 54.33 },
  { id: "tesamorelin10", name: "TESAMORELIN 10MG", price: 92.70 },
  { id: "ss31", name: "SS-31 10MG", price: 49.63 },
  { id: "motsc", name: "MOTS-C 10MG", price: 34.48 },
  { id: "amino1mq", name: "5-AMINO-1MQ 5MG", price: 24.55 },
  { id: "nad500", name: "NAD+ 500MG", price: 40.23 },
  { id: "bpc157", name: "BPC-157 + TB500 10MG", price: 51.00 },
  { id: "aod9604", name: "AOD9604 5MG", price: 53.00 },
  { id: "slupp332", name: "SLU-PP-332 5MG", price: 63.60 },
  { id: "cagrilintide", name: "CAGRILINTIDE 10MG", price: 104.00 },
  { id: "cjc1295", name: "CJC-1295 s/DAC 5MG + IPAMORELIN 5MG", price: 50.50 },
  { id: "glow70", name: "GLOW 70MG", price: 95.40 },
];

function App() {
  const [data, setData] = useState({});
  const [view, setView] = useState("list");
  const [modal, setModal] = useState(null); // { peptideId, editMode, editName, editRoundIdx, editCurrentQty, editCode }
  const [form, setForm] = useState({ name: "", qty: 1 });
  const [myName, setMyName] = useState(() => localStorage.getItem("rateio-nome") || "");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState(null);
  const [search, setSearch] = useState("");
  const [codeModal, setCodeModal] = useState(null);

  async function fetchData() {
    try {
      const res = await fetch("/api/data");
      setData(await res.json());
    } catch(e) {}
    setLoading(false);
  }

  useEffect(() => { fetchData(); const t = setInterval(fetchData, 8000); return () => clearInterval(t); }, []);

  function showToast(msg, type = "success") {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  }

  function saveName(name) {
    setMyName(name);
    localStorage.setItem("rateio-nome", name);
  }

  function getRounds(id) {
    const r = data[id];
    return (!r || r.length === 0) ? [[]] : r;
  }

  function getRoundTotal(round) {
    return round.reduce((s, p) => s + p.qty, 0);
  }

  function getActiveRound(id) {
    const rounds = getRounds(id);
    const lastIdx = rounds.length - 1;
    const lastRound = rounds[lastIdx];
    const total = getRoundTotal(lastRound);
    const spots = MAX_PER_ROUND - total;
    return { roundIdx: lastIdx, round: lastRound, total, spots, isFull: spots === 0 };
  }

  function generateCode() {
    return String(Math.floor(100000 + Math.random() * 900000));
  }

  async function saveRounds(peptideId, rounds) {
    setSaving(true);
    try {
      await fetch("/api/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ peptideId, participants: rounds })
      });
      await fetchData();
    } catch(e) { showToast("Erro ao salvar.", "error"); }
    setSaving(false);
  }

  function openModal(peptideId) {
    setModal({ peptideId, editMode: false });
    setForm({ name: myName, qty: 1 });
  }

  function openEditModal(peptideId, roundIdx, participant) {
    setModal({ peptideId, editMode: true, editName: participant.name, editRoundIdx: roundIdx, editCurrentQty: participant.qty, editCode: participant.code });
    setForm({ name: participant.name, qty: participant.qty });
  }

  async function handleAdd() {
    if (!form.name.trim()) return;
    const { peptideId } = modal;
    const peptide = PEPTIDES.find(p => p.id === peptideId);
    const rounds = getRounds(peptideId);
    const { isFull, spots } = getActiveRound(peptideId);
    const code = generateCode();

    let newRounds;
    if (isFull) {
      newRounds = [...rounds, [{ name: form.name.trim(), qty: form.qty, code }]];
    } else {
      if (form.qty > spots) { showToast(`S√≥ restam ${spots} vaga${spots!==1?"s":""}!`, "error"); return; }
      let lastRound = [...rounds[rounds.length - 1]];
      const existing = lastRound.findIndex(p => p.name.toLowerCase() === form.name.trim().toLowerCase());
      if (existing >= 0) {
        lastRound[existing] = { ...lastRound[existing], qty: lastRound[existing].qty + form.qty };
        newRounds = [...rounds.slice(0, -1), lastRound];
        saveName(form.name.trim());
        setModal(null);
        await saveRounds(peptideId, newRounds);
        showToast(`Inscrito em ${peptide.name}!`);
        return;
      } else {
        lastRound.push({ name: form.name.trim(), qty: form.qty, code });
      }
      newRounds = [...rounds.slice(0, -1), lastRound];
    }

    saveName(form.name.trim());
    setModal(null);
    await saveRounds(peptideId, newRounds);
    setCodeModal({ name: form.name.trim(), code, peptideName: peptide.name });
  }

  async function handleEdit() {
    const { peptideId, editName, editRoundIdx, editCurrentQty, editCode } = modal;
    const peptide = PEPTIDES.find(p => p.id === peptideId);

    // Ask for code or admin
    const input = window.prompt(`Digite seu c√≥digo de confirma√ß√£o para editar:\nN√£o lembra? Fale com o Leonardo (admin)`);
    if (input === null) return;
    const isAdmin = input === ADMIN_PASS;
    const isOwner = editCode && input === editCode;
    if (!isAdmin && !isOwner) { showToast("C√≥digo incorreto!", "error"); return; }

    const rounds = getRounds(peptideId);
    const round = rounds[editRoundIdx];
    const othersTotal = round.filter(p => p.name !== editName).reduce((s, p) => s + p.qty, 0);
    const maxAllowed = MAX_PER_ROUND - othersTotal;

    if (form.qty > maxAllowed) { showToast(`M√°ximo ${maxAllowed} und nesta rodada!`, "error"); return; }
    if (form.qty < 1) { showToast("M√≠nimo 1 unidade.", "error"); return; }

    const newRound = round.map(p => p.name === editName ? { ...p, qty: form.qty } : p);
    const newRounds = rounds.map((r, i) => i === editRoundIdx ? newRound : r);
    setModal(null);
    await saveRounds(peptideId, newRounds);
    showToast(`Quantidade atualizada!`);
  }

  async function handleRemove(peptideId, roundIdx, participant) {
    const input = window.prompt(`Digite seu c√≥digo de confirma√ß√£o para remover "${participant.name}":\nN√£o lembra? Fale com o Leonardo (admin)`);
    if (input === null) return;
    const isAdmin = input === ADMIN_PASS;
    const isOwner = participant.code && input === participant.code;
    if (!isAdmin && !isOwner) { showToast("C√≥digo incorreto!", "error"); return; }

    const rounds = getRounds(peptideId);
    const newRounds = rounds.map((r, i) => i === roundIdx ? r.filter(p => p.name !== participant.name) : r);
    const cleaned = newRounds.filter((r, i) => i === 0 || r.length > 0);
    await saveRounds(peptideId, cleaned.length ? cleaned : [[]]);
    showToast("Removido com sucesso", "info");
  }

  async function handleClosedRoundAction(peptide, roundIdx, participant) {
    const input = window.prompt(`C√≥digo de confirma√ß√£o de ${participant.name}:\nN√£o lembra? Fale com o Leonardo (admin)`);
    if (input === null) return;
    const isAdmin = input === ADMIN_PASS;
    const isOwner = participant.code && input === participant.code;
    if (!isAdmin && !isOwner) { showToast("C√≥digo incorreto!", "error"); return; }

    const action = window.confirm(`O que deseja fazer com ${participant.name}?\n\nOK = Editar quantidade\nCancelar = Remover`);
    
    if (action) {
      // Edit
      const newQtyStr = window.prompt(`Nova quantidade para ${participant.name} (atual: ${participant.qty}, m√°x 10):`);
      if (newQtyStr === null) return;
      const newQty = parseInt(newQtyStr);
      if (isNaN(newQty) || newQty < 1 || newQty > 10) { showToast("Quantidade inv√°lida!", "error"); return; }
      const rounds = getRounds(peptide.id);
      const round = rounds[roundIdx];
      const othersTotal = round.filter(p => p.name !== participant.name).reduce((s,p) => s + p.qty, 0);
      if (newQty + othersTotal > MAX_PER_ROUND) { showToast(`M√°ximo ${MAX_PER_ROUND - othersTotal} und dispon√≠vel!`, "error"); return; }
      const newRound = round.map(p => p.name === participant.name ? { ...p, qty: newQty } : p);
      const newRounds = rounds.map((r, i) => i === roundIdx ? newRound : r);
      await saveRounds(peptide.id, newRounds);
      showToast("Quantidade atualizada!");
    } else {
      // Remove
      const rounds = getRounds(peptide.id);
      const newRounds = rounds.map((r, i) => i === roundIdx ? r.filter(p => p.name !== participant.name) : r);
      const cleaned = newRounds.filter((r, i) => i === 0 || r.length > 0);
      await saveRounds(peptide.id, cleaned.length ? cleaned : [[]]);
      showToast("Removido da rodada fechada", "info");
    }
  }

  async function handleRemoveFromClosedRound(peptideId, roundIdx, name) {
    const senha = window.prompt(`Digite o c√≥digo de confirma√ß√£o para remover "${name}":\nN√£o lembra? Fale com o Leonardo (admin)`);
    if (senha === null) return;
    if (senha !== ADMIN_PASS) { showToast("Senha incorreta!", "error"); return; }
    const rounds = getRounds(peptideId);
    const newRounds = rounds.map((r, i) => i === roundIdx ? r.filter(p => p.name !== name) : r);
    const cleaned = newRounds.filter((r, i) => i === 0 || r.length > 0);
    await saveRounds(peptideId, cleaned.length ? cleaned : [[]]);
    showToast("Removido da rodada fechada", "info");
  }

  async function handleClearPeptide(peptideId, peptideName) {
    const senha = window.prompt(`Digite o c√≥digo de confirma√ß√£o para limpar ${peptideName}:\nN√£o lembra? Fale com o Leonardo (admin)`);
    if (senha === null) return;
    if (senha !== ADMIN_PASS) { showToast("Senha incorreta!", "error"); return; }
    await saveRounds(peptideId, [[]]);
    showToast(`${peptideName} limpo!`, "info");
  }

  function copyToWhatsApp() {
    let text = "üíä *RATEIO PEPT√çDEOS*\n";
    text += "Compra: 24/02 | Prazo: 23/02 | Taxa: 20% | Frete separado\n\n";
    PEPTIDES.forEach(peptide => {
      const rounds = getRounds(peptide.id);
      const hasAny = rounds.some(r => r.length > 0);
      if (!hasAny) return;
      rounds.forEach((round, rIdx) => {
        if (round.length === 0) return;
        const total = getRoundTotal(round);
        const closed = total >= MAX_PER_ROUND;
        text += `*${peptide.name}* ${closed ? "‚úÖ" : `(${total}/10)`}\n`;
        text += `R$ ${peptide.price.toFixed(2)}/und`;
        if (rounds.length > 1) text += ` | Rodada ${rIdx+1}`;
        text += "\n";
        round.forEach(p => { text += `${p.name} ${p.qty}\n`; });
        text += "\n";
      });
    });
    navigator.clipboard.writeText(text).then(() => showToast("Lista copiada para a √°rea de transfer√™ncia! üìã")).catch(() => showToast("Erro ao copiar.", "error"));
  }

  function getSummary() {
    const summary = {};
    PEPTIDES.forEach(peptide => {
      getRounds(peptide.id).forEach((round, rIdx) => {
        round.forEach(p => {
          if (!summary[p.name]) summary[p.name] = [];
          summary[p.name].push({ peptide, qty: p.qty, total: p.qty * peptide.price, round: rIdx+1, totalRounds: getRounds(peptide.id).length });
        });
      });
    });
    return summary;
  }

  const filtered = PEPTIDES.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
  const summary = getSummary();
  const myItems = myName ? (summary[myName] || []) : [];

  if (loading) return <div style={{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",color:"#a78bfa",fontSize:18}}>Carregando...</div>;

  const TABS = [
    { id: "list", label: "üìã Pept√≠deos" },
    { id: "summary", label: "üìä Por Pessoa" },
    { id: "closed", label: "üîí Fechados" },
    { id: "mine", label: "üë§ Meu Pedido" },
  ];

  return (
    <div style={{minHeight:"100vh",paddingBottom:40}}>

      {/* Toast */}
      {toast && <div style={{position:"fixed",top:16,left:"50%",transform:"translateX(-50%)",background:toast.type==="error"?"#7f1d1d":toast.type==="info"?"#1e3a5f":"#14532d",color:"#fff",padding:"10px 20px",borderRadius:12,zIndex:999,fontSize:14,boxShadow:"0 4px 20px rgba(0,0,0,0.5)",maxWidth:"90vw",textAlign:"center"}}>{toast.msg}</div>}

      {/* Code Modal */}
      {codeModal && (
        <div style={{position:"fixed",inset:0,background:"#000000ee",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200,padding:16}}>
          <div style={{background:"#1a1a2e",borderRadius:20,padding:28,width:"100%",maxWidth:400,border:"2px solid #4f46e5",textAlign:"center"}}>
            <div style={{fontSize:32,marginBottom:8}}>üéâ</div>
            <div style={{fontWeight:700,fontSize:16,color:"#c4b5fd",marginBottom:4}}>Inscri√ß√£o confirmada!</div>
            <div style={{fontSize:13,color:"#818cf8",marginBottom:20}}>{codeModal.peptideName}</div>
            <div style={{fontSize:13,color:"#94a3b8",marginBottom:8}}>Seu c√≥digo pessoal:</div>
            <div style={{background:"#0f0f1a",borderRadius:12,padding:"16px",marginBottom:16,border:"2px solid #4f46e5"}}>
              <div style={{fontSize:36,fontWeight:900,color:"#a78bfa",letterSpacing:8}}>{codeModal.code}</div>
            </div>
            <div style={{fontSize:12,color:"#f59e0b",marginBottom:20,background:"#1c1407",padding:"10px",borderRadius:10,border:"1px solid #92400e"}}>
              ‚ö†Ô∏è Anote! Sem ele s√≥ o admin pode te remover ou editar.
            </div>
            <button onClick={()=>setCodeModal(null)} style={{width:"100%",padding:12,borderRadius:12,border:"none",background:"linear-gradient(135deg,#4f46e5,#7c3aed)",color:"#fff",fontSize:15,fontWeight:700,cursor:"pointer"}}>Entendi, j√° anotei! ‚úÖ</button>
          </div>
        </div>
      )}

      {/* Header */}
      <div style={{background:"linear-gradient(135deg,#1e1b4b,#312e81)",padding:"20px 16px 16px",borderBottom:"1px solid #3730a3"}}>
        <div style={{maxWidth:600,margin:"0 auto"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <h1 style={{fontSize:20,fontWeight:700,color:"#c4b5fd"}}>üíä Rateio Pept√≠deos</h1>
              <p style={{marginTop:4,fontSize:12,color:"#818cf8"}}>Compra: 24/02 ¬∑ Prazo: 23/02 ¬∑ 10 und/rodada</p>
            </div>
            <div style={{fontSize:11,color:"#6366f1",background:"#1e1b4b",padding:"8px 12px",borderRadius:10,border:"1px solid #3730a3",textAlign:"right"}}>
              <div>üí∞ Taxa: 20%</div><div>üì¶ Frete separado</div>
            </div>
          </div>
          <input value={myName} onChange={e=>saveName(e.target.value)} placeholder="Seu nome (salvo automaticamente)"
            style={{marginTop:12,width:"100%",padding:"10px 14px",borderRadius:10,background:"#1e1b4b",border:"1px solid #4338ca",color:"#e2e8f0",fontSize:14}} />
        </div>
      </div>

      <div style={{maxWidth:600,margin:"0 auto",padding:"12px 16px 0"}}>

        {/* Tabs */}
        <div style={{display:"flex",gap:6,marginBottom:12,overflowX:"auto",paddingBottom:4}}>
          {TABS.map(t=>(
            <button key={t.id} onClick={()=>setView(t.id)} style={{flex:"0 0 auto",padding:"8px 12px",borderRadius:10,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,whiteSpace:"nowrap",background:view===t.id?"#4f46e5":"#1e1b4b",color:view===t.id?"#fff":"#818cf8"}}>{t.label}</button>
          ))}
          <button onClick={copyToWhatsApp} style={{flex:"0 0 auto",padding:"8px 12px",borderRadius:10,border:"1px solid #166534",cursor:"pointer",fontSize:12,fontWeight:600,whiteSpace:"nowrap",background:"transparent",color:"#4ade80"}}>üìã Copiar Lista</button>
        </div>

        {saving && <div style={{textAlign:"center",fontSize:12,color:"#6366f1",marginBottom:8}}>Salvando...</div>}

        {/* LIST TAB */}
        {view==="list" && <>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="üîç Buscar pept√≠deo..."
            style={{width:"100%",padding:"10px 14px",borderRadius:10,marginBottom:12,background:"#1e1b4b",border:"1px solid #3730a3",color:"#e2e8f0",fontSize:14}} />
          {filtered.map(peptide => {
            const rounds = getRounds(peptide.id);
            const { spots, isFull, total } = getActiveRound(peptide.id);
            const pct = (total / MAX_PER_ROUND) * 100;
            const totalRounds = rounds.length;
            return (
              <div key={peptide.id} style={{background:"#1a1a2e",border:`1px solid ${isFull?"#22c55e33":"#2d2d4e"}`,borderRadius:14,padding:14,marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:700,fontSize:14,color:"#c4b5fd"}}>üíâ {peptide.name}</div>
                    <div style={{fontSize:12,color:"#6366f1",marginTop:2}}>R$ {peptide.price.toFixed(2)}/und ¬∑ 10 und/rodada</div>
                  </div>
                  <div style={{textAlign:"right"}}>
                    {totalRounds > 1 && <div style={{fontSize:11,color:"#6366f1",marginBottom:2}}>{totalRounds} rodadas</div>}
                    <div style={{fontSize:13,fontWeight:700,color:isFull?"#22c55e":spots<=2?"#f59e0b":"#a78bfa"}}>{total}/{MAX_PER_ROUND}</div>
                    <div style={{fontSize:11,color:"#64748b"}}>{isFull?"‚úÖ nova rodada!":spots+" livre"+(spots!==1?"s":"")}</div>
                  </div>
                </div>
                <div style={{height:6,background:"#2d2d4e",borderRadius:99,margin:"10px 0 8px",overflow:"hidden"}}>
                  <div style={{height:"100%",borderRadius:99,width:`${pct}%`,transition:"width 0.4s",background:isFull?"#22c55e":pct>70?"#f59e0b":"#4f46e5"}} />
                </div>
                {rounds.map((round, rIdx) => {
                  if (round.length === 0) return null;
                  const roundComplete = getRoundTotal(round) >= MAX_PER_ROUND;
                  const isActiveRound = rIdx === rounds.length - 1 && !roundComplete;
                  return (
                    <div key={rIdx} style={{marginBottom:rIdx<rounds.length-1?8:0}}>
                      {(totalRounds > 1 || roundComplete) && (
                        <div style={{display:"flex",alignItems:"center",gap:6,fontSize:11,color:"#6366f1",fontWeight:600,marginBottom:4}}>
                          {totalRounds > 1 && `üì¶ Rodada ${rIdx+1} ‚Äî ${getRoundTotal(round)}/10`}
                          {roundComplete && <span style={{background:"#14532d",color:"#22c55e",borderRadius:99,padding:"1px 7px",fontSize:10}}>üîí fechada</span>}
                        </div>
                      )}
                      <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                        {round.map((p,i)=>(
                          <div key={i} style={{display:"flex",alignItems:"center",gap:4,background:roundComplete?"#1e2d1e":"#2d2d4e",borderRadius:99,padding:"3px 10px 3px 8px",fontSize:12,border:roundComplete?"1px solid #166534":"none"}}>
                            <span style={{color:roundComplete?"#86efac":"#e2e8f0"}}>{p.name}</span>
                            <span style={{color:"#6366f1",fontWeight:700}}>√ó{p.qty}</span>
                            {isActiveRound && <>
                              <button onClick={()=>openEditModal(peptide.id, rIdx, p)} style={{background:"none",border:"none",color:"#818cf8",cursor:"pointer",fontSize:11,padding:0,lineHeight:1,marginLeft:1}} title="Editar quantidade">‚úèÔ∏è</button>
                              <button onClick={()=>handleRemove(peptide.id,rIdx,p)} style={{background:"none",border:"none",color:"#ef4444",cursor:"pointer",fontSize:14,padding:0,lineHeight:1}}>√ó</button>
                            </>}
                            {roundComplete && (
                              <button onClick={()=>handleClosedRoundAction(peptide, rIdx, p)} style={{background:"#1e1b4b",border:"1px solid #6366f1",borderRadius:8,color:"#a78bfa",cursor:"pointer",fontSize:11,padding:"2px 8px",fontWeight:600,marginLeft:2}}>‚úèÔ∏è editar</button>
                            )}
                          </div>
                        ))}
                      </div>
                      {roundComplete && <div style={{fontSize:10,color:"#4ade80",marginTop:4}}>üîí Rodada completa ‚Äî protegida</div>}
                    </div>
                  );
                })}
                <div style={{display:"flex",gap:8,marginTop:rounds[0].length>0?10:0}}>
                  <button onClick={()=>openModal(peptide.id)} style={{flex:1,padding:"8px",borderRadius:8,border:"1px solid #4338ca",background:"transparent",color:"#818cf8",fontSize:13,cursor:"pointer",fontWeight:600}}>
                    {isFull ? `‚ú® Entrar na Rodada ${totalRounds+1}` : "+ Quero esse"}
                  </button>
                  <button onClick={()=>handleClearPeptide(peptide.id,peptide.name)} title="Limpar (admin)" style={{padding:"8px 12px",borderRadius:8,border:"1px solid #3f1515",background:"transparent",color:"#ef444455",fontSize:13,cursor:"pointer"}}>üóëÔ∏è</button>
                </div>
              </div>
            );
          })}
        </>}

        {/* SUMMARY TAB */}
        {view==="summary" && (
          <div>
            {Object.keys(summary).sort().map(name => {
              const items = summary[name];
              const totalBRL = items.reduce((s,i)=>s+i.total,0);
              return (
                <div key={name} style={{background:"#1a1a2e",border:"1px solid #2d2d4e",borderRadius:14,padding:14,marginBottom:10}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                    <div style={{fontWeight:700,fontSize:15,color:"#c4b5fd"}}>üë§ {name}</div>
                    <div style={{textAlign:"right"}}>
                      <div style={{fontSize:13,color:"#22c55e",fontWeight:700}}>R$ {(totalBRL*1.2).toFixed(2)}</div>
                      <div style={{fontSize:10,color:"#64748b"}}>c/ taxa 20%</div>
                    </div>
                  </div>
                  {items.map((item,i)=>(
                    <div key={i} style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#94a3b8",padding:"4px 0",borderTop:"1px solid #1e1b4b"}}>
                      <span>{item.peptide.name} √ó{item.qty}{item.totalRounds>1?` (Rod.${item.round})`:""}</span>
                      <span style={{color:"#a78bfa"}}>R$ {item.total.toFixed(2)}</span>
                    </div>
                  ))}
                  <div style={{marginTop:8,paddingTop:8,borderTop:"1px solid #2d2d4e",display:"flex",justifyContent:"space-between",fontSize:12}}>
                    <span style={{color:"#64748b"}}>Subtotal s/ taxa</span>
                    <span style={{color:"#6366f1"}}>R$ {totalBRL.toFixed(2)}</span>
                  </div>
                  <div style={{fontSize:11,color:"#64748b",marginTop:2}}>+ frete (a calcular)</div>
                </div>
              );
            })}
            {Object.keys(summary).length===0 && <div style={{textAlign:"center",color:"#475569",padding:40}}>Nenhuma inscri√ß√£o ainda</div>}
          </div>
        )}

        {/* CLOSED TAB */}
        {view==="closed" && (() => {
          const closedRounds = [];
          PEPTIDES.forEach(peptide => {
            getRounds(peptide.id).forEach((round, rIdx) => {
              if (getRoundTotal(round) >= MAX_PER_ROUND) closedRounds.push({ peptide, round, roundIdx: rIdx, totalRounds: getRounds(peptide.id).length });
            });
          });
          const grandTotal = closedRounds.reduce((s, item) => s + item.round.reduce((ss, p) => ss + p.qty * item.peptide.price, 0), 0);
          return (
            <div>
              {closedRounds.length > 0 && (
                <div style={{background:"#14532d",borderRadius:12,padding:12,marginBottom:12,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontSize:13,color:"#86efac",fontWeight:700}}>Total da compra (rodadas fechadas)</div>
                    <div style={{fontSize:11,color:"#4ade80"}}>s/ frete</div>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <div style={{fontSize:18,color:"#22c55e",fontWeight:900}}>R$ {(grandTotal*1.2).toFixed(2)}</div>
                    <div style={{fontSize:11,color:"#4ade80"}}>c/ taxa 20%</div>
                  </div>
                </div>
              )}
              {closedRounds.length === 0 && <div style={{textAlign:"center",color:"#475569",padding:40}}>Nenhuma rodada fechada ainda</div>}
              {closedRounds.map((item, i) => (
                <div key={i} style={{background:"#1a1a2e",border:"1px solid #166534",borderRadius:14,padding:14,marginBottom:10}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                    <div>
                      <div style={{fontWeight:700,fontSize:14,color:"#86efac"}}>‚úÖ {item.peptide.name}</div>
                      <div style={{fontSize:11,color:"#4ade80",marginTop:2}}>{item.totalRounds>1?`Rodada ${item.roundIdx+1} de ${item.totalRounds}`:"Rodada 1"} ¬∑ 10/10 und</div>
                    </div>
                    <div style={{textAlign:"right"}}>
                      <div style={{fontSize:13,fontWeight:700,color:"#22c55e"}}>R$ {(item.round.reduce((s,p)=>s+p.qty*item.peptide.price,0)*1.2).toFixed(2)}</div>
                      <div style={{fontSize:10,color:"#4ade80"}}>c/ taxa 20%</div>
                    </div>
                  </div>
                  <div style={{height:4,background:"#22c55e",borderRadius:99,marginBottom:10}} />
                  {item.round.map((p, pi) => (
                    <div key={pi} style={{display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:12,color:"#86efac",padding:"4px 0",borderTop:"1px solid #14532d"}}>
                      <span>üë§ {p.name}</span>
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        <span style={{fontWeight:700}}>√ó{p.qty} ¬∑ R$ {(p.qty*item.peptide.price).toFixed(2)}</span>
                        <button onClick={()=>handleClosedRoundAction(item.peptide, item.roundIdx, p)} style={{background:"#1e1b4b",border:"1px solid #6366f1",borderRadius:8,color:"#a78bfa",cursor:"pointer",fontSize:12,padding:"4px 10px",fontWeight:600}}>‚úèÔ∏è editar</button>
                      </div>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          );
        })()}

        {/* MY ORDER TAB */}
        {view==="mine" && (
          <div>
            {!myName && <div style={{textAlign:"center",color:"#475569",padding:40}}>Digite seu nome no campo acima para ver seu pedido</div>}
            {myName && myItems.length === 0 && <div style={{textAlign:"center",color:"#475569",padding:40}}>Nenhuma inscri√ß√£o encontrada para <strong style={{color:"#818cf8"}}>{myName}</strong></div>}
            {myName && myItems.length > 0 && (() => {
              const totalBRL = myItems.reduce((s,i)=>s+i.total,0);
              return (
                <div>
                  <div style={{background:"#1e1b4b",borderRadius:12,padding:12,marginBottom:12,textAlign:"center",border:"1px solid #3730a3"}}>
                    <div style={{fontSize:14,color:"#c4b5fd",fontWeight:700,marginBottom:4}}>üë§ {myName}</div>
                    <div style={{fontSize:22,color:"#22c55e",fontWeight:900}}>R$ {(totalBRL*1.2).toFixed(2)}</div>
                    <div style={{fontSize:11,color:"#6366f1"}}>total c/ taxa 20% ¬∑ s/ frete</div>
                  </div>
                  {myItems.map((item, i) => (
                    <div key={i} style={{background:"#1a1a2e",border:"1px solid #2d2d4e",borderRadius:12,padding:12,marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <div>
                        <div style={{fontSize:13,color:"#c4b5fd",fontWeight:600}}>üíâ {item.peptide.name}</div>
                        {item.totalRounds>1 && <div style={{fontSize:11,color:"#6366f1",marginTop:2}}>Rodada {item.round}</div>}
                      </div>
                      <div style={{textAlign:"right"}}>
                        <div style={{fontSize:13,color:"#a78bfa",fontWeight:700}}>√ó{item.qty}</div>
                        <div style={{fontSize:12,color:"#6366f1"}}>R$ {item.total.toFixed(2)}</div>
                      </div>
                    </div>
                  ))}
                  <div style={{background:"#1a1a2e",border:"1px solid #2d2d4e",borderRadius:12,padding:12,marginTop:4}}>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:"#94a3b8",marginBottom:4}}>
                      <span>Subtotal s/ taxa</span><span style={{color:"#6366f1"}}>R$ {totalBRL.toFixed(2)}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:"#94a3b8",marginBottom:4}}>
                      <span>Taxa 20%</span><span style={{color:"#f59e0b"}}>R$ {(totalBRL*0.2).toFixed(2)}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:14,fontWeight:700,paddingTop:8,borderTop:"1px solid #2d2d4e"}}>
                      <span style={{color:"#e2e8f0"}}>Total s/ frete</span><span style={{color:"#22c55e"}}>R$ {(totalBRL*1.2).toFixed(2)}</span>
                    </div>
                    <div style={{fontSize:11,color:"#64748b",marginTop:4,textAlign:"center"}}>+ frete (a calcular no final)</div>
                  </div>
                </div>
              );
            })()}
          </div>
        )}
      </div>

      {/* ADD/EDIT MODAL */}
      {modal && (() => {
        const peptide = PEPTIDES.find(p => p.id === modal.peptideId);
        const { spots, isFull, roundIdx } = getActiveRound(modal.peptideId);
        const rounds = getRounds(modal.peptideId);
        const isEdit = modal.editMode;

        let availableSpots, currentRound;
        if (isEdit) {
          const round = rounds[modal.editRoundIdx];
          const othersTotal = round.filter(p => p.name !== modal.editName).reduce((s,p) => s + p.qty, 0);
          availableSpots = MAX_PER_ROUND - othersTotal;
          currentRound = modal.editRoundIdx + 1;
        } else {
          currentRound = isFull ? rounds.length+1 : roundIdx+1;
          availableSpots = isFull ? MAX_PER_ROUND : spots;
        }

        return (
          <div style={{position:"fixed",inset:0,background:"#000000bb",display:"flex",alignItems:"flex-end",justifyContent:"center",zIndex:100}} onClick={()=>setModal(null)}>
            <div style={{background:"#1a1a2e",borderRadius:"20px 20px 0 0",padding:24,width:"100%",maxWidth:600,border:"1px solid #3730a3"}} onClick={e=>e.stopPropagation()}>
              <div style={{fontWeight:700,fontSize:16,color:"#c4b5fd",marginBottom:2}}>
                {isEdit ? "‚úèÔ∏è Editar quantidade" : "üíâ "+peptide.name}
              </div>
              <div style={{fontSize:12,color:(!isEdit&&isFull)?"#22c55e":"#6366f1",marginBottom:16}}>
                {isEdit ? `${peptide.name} ¬∑ Rodada ${currentRound}` : (isFull ? `üéâ Rodada ${currentRound} aberta!` : `Rodada ${currentRound} ¬∑ ${availableSpots} vaga${availableSpots!==1?"s":""} ¬∑ R$ ${peptide.price.toFixed(2)}/und`)}
              </div>

              {!isEdit && <>
                <label style={{fontSize:13,color:"#94a3b8"}}>Seu nome</label>
                <input value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))} placeholder="Nome completo"
                  style={{display:"block",width:"100%",marginTop:4,marginBottom:12,padding:"10px 14px",borderRadius:10,background:"#0f0f1a",border:"1px solid #3730a3",color:"#e2e8f0",fontSize:14}} />
              </>}

              <label style={{fontSize:13,color:"#94a3b8"}}>{isEdit ? `Quantidade (m√°x ${availableSpots})` : "Quantidade"}</label>
              <div style={{display:"flex",gap:8,marginTop:4,marginBottom:16}}>
                {[1,2,3,4,5].filter(n=>n<=availableSpots).map(n=>(
                  <button key={n} onClick={()=>setForm(f=>({...f,qty:n}))} style={{flex:1,padding:"10px 0",borderRadius:10,border:"1px solid",borderColor:form.qty===n?"#4f46e5":"#2d2d4e",background:form.qty===n?"#4f46e5":"transparent",color:form.qty===n?"#fff":"#94a3b8",fontSize:15,cursor:"pointer",fontWeight:700}}>{n}</button>
                ))}
                {availableSpots>5 && <input type="number" min={1} max={availableSpots} value={form.qty} onChange={e=>setForm(f=>({...f,qty:Math.min(availableSpots,Math.max(1,parseInt(e.target.value)||1))}))} style={{flex:1,padding:"10px",borderRadius:10,background:"#0f0f1a",border:`1px solid ${form.qty>5?"#4f46e5":"#2d2d4e"}`,color:"#e2e8f0",fontSize:14,textAlign:"center"}} />}
              </div>

              <div style={{background:"#0f0f1a",borderRadius:10,padding:12,marginBottom:16,fontSize:13}}>
                <div style={{display:"flex",justifyContent:"space-between",color:"#94a3b8"}}><span>Subtotal s/ taxa:</span><span style={{color:"#a78bfa",fontWeight:700}}>R$ {(peptide.price*form.qty).toFixed(2)}</span></div>
                <div style={{display:"flex",justifyContent:"space-between",color:"#94a3b8",marginTop:4}}><span>Com taxa 20%:</span><span style={{color:"#22c55e",fontWeight:700}}>R$ {(peptide.price*form.qty*1.2).toFixed(2)}</span></div>
              </div>

              <button onClick={isEdit ? handleEdit : handleAdd} disabled={!isEdit && !form.name.trim()} style={{width:"100%",padding:14,borderRadius:12,border:"none",background:(!isEdit&&!form.name.trim())?"#2d2d4e":"linear-gradient(135deg,#4f46e5,#7c3aed)",color:(!isEdit&&!form.name.trim())?"#475569":"#fff",fontSize:15,fontWeight:700,cursor:(!isEdit&&!form.name.trim())?"not-allowed":"pointer"}}>
                {isEdit ? "‚úÖ Salvar altera√ß√£o" : "‚úÖ Confirmar inscri√ß√£o"}
              </button>
            </div>
          </div>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
